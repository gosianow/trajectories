### Define the version of R and the path to software
R := R CMD BATCH --no-restore --no-save
RWD_MAIN := /Users/gosia/Dropbox/UZH/trajectories_data
RCODE := /Users/gosia/Dropbox/UZH/trajectories_code
RWD := $(RWD_MAIN)/simulation1
ROUT := $(RWD)/Rout

dir_mat := $(RWD)/01_data_mat
dir_r := $(RWD)/01_data_r
dir_fcs := $(RWD)/01_fcs_files
dir_panel := $(RWD)/01_panel
dir_truth := $(RWD)/02_truth
dir_plot_cell_density := $(RWD)/04_plot_cell_density

file_mat := albeck2008_Poisson_10000_25000_100.mat

### Define a list of FCS files that should be analyzed
DATA := sim1
FCS := sim1_sub1


## Define the default rule (makefiles are usually written so that the first target is for compiling the entire program)
.PHONY: all
all: mkdir_rout plot_cell_density_goal


### Make sure no intermediate files are deleted
.SECONDARY:

.PHONY: mkdir_rout
mkdir_rout:
	mkdir -p $(ROUT)


# ----------------------------------------------------------------------
### Extract simulated data from the .mat file
# ----------------------------------------------------------------------

$(dir_r)/$(FCS).rds $(dir_fcs)/$(FCS).fcs $(dir_panel)/$(DATA)_panel.txt $(dir_truth)/$(FCS)_truth_trajectory.txt: \
 $(dir_mat)/$(file_mat) $(RCODE)/01_readin_simulatios.R
	$R "--args rwd='$(RWD)' outdir_r='$(dir_r)' outdir_fcs='$(dir_fcs)' outdir_panel='$(dir_panel)' \
	outdir_truth='$(dir_truth)' path_data='$(dir_mat)/$(file_mat)'" $(RCODE)/01_readin_simulatios.R \
	$(ROUT)/01_readin_simulatios.Rout
	tail $(ROUT)/01_readin_simulatios.Rout

# ----------------------------------------------------------------------
### Plot cell density over time
# ----------------------------------------------------------------------

.PHONY: plot_cell_density_goal
plot_cell_density_goal: $(addprefix $(dir_plot_cell_density)/, $(addsuffix _truth_cell_density_density.pdf, $(foreach X,$(FCS),$X)))

define plot_cell_density_rule
$(dir_plot_cell_density)/$(1)_truth_cell_density_density.pdf $(dir_plot_cell_density)/$(1)_truth_cell_density_hist.pdf: \
$(dir_truth)/$(1)_truth_trajectory.txt $(RCODE)/02_plot_cell_density_over_time.R
	$R "--args rwd='$(RWD)' outdir='$(dir_plot_cell_density)' prefix='$(1)_truth_' \
	path_trajectory='$(dir_truth)/$(1)_truth_trajectory.txt'" $(RCODE)/02_plot_cell_density_over_time.R \
	$(ROUT)/02_plot_cell_density_over_time.Rout
	tail $(ROUT)/02_plot_cell_density_over_time.Rout
endef
$(foreach i,$(FCS),$(eval $(call plot_cell_density_rule,$(i))))













###
